function startGraph(){myNetwork=Network(),d3.selectAll("#layouts .selectable").on("click",function(){var t=activate("layouts",$(this));return t?("radial"===t?$("#sorts").css("opacity",0).effect("slide",{direction:"right",mode:"show"},500).animate({opacity:1},500):$("#sorts").animate({opacity:0},500).effect("slide",{direction:"left",mode:"hide"},500),myNetwork.toggleLayout(t)):!1}),d3.selectAll("#filters .selectable").on("click",function(){var t=activate("filters",$(this));return t?myNetwork.toggleFilter(t):!1}),d3.selectAll("#sorts .selectable").on("click",function(){var t=activate("sorts",$(this));return t?myNetwork.toggleSort(t):!1}),d3.selectAll("#features .selectable").on("click",function(){var t=activate("features",$(this));return t?myNetwork.toggleFeature(t):!1}),d3.selectAll("#features #addFeature").on("click",function(){alert("this doesn't work yet")}),d3.selectAll("#interactions .interactionType").on("mouseover",function(){return myNetwork.highlightSpecificInteractions(d3.select(this).attr("title"))}).on("mouseout",function(){return myNetwork.removeLinkHighlighting()}).on("change",function(){d3.selectAll("#selectedInteractions").classed("active")&&d3.selectAll("#selectedInteractions").classed("active",!1)}),$("#search").keyup(function(){var t=$(this).val();return myNetwork.updateSearch(t)});var t=getNetwork();return t?(myNetwork("#graph",t),!0):!1}function getInteractionTypes(){$.ajax({type:"GET",url:"updateInteractions",data:{organism:"Scerevisiae"},dataType:"json",beforeSend:function(){disableElement(".control"),maskElement("window",!0)},success:function(t){var e="",n=2,r=0;jQuery.each(t,function(t,a){e+='<fieldset class="'+t+' iFieldset">',e+='<label class="title">'+t+'<span class="controller selected" onclick="toggleSelected(this, \''+t+"')\">",e+=" (Select All / None)</span> </label>",e+='<div style="float:left;">';for(var i=0,o=a.length,u=o/n+.99999999,s=0;s<a.length;s++)r+=1,i>=u&&(e+='</div><div style="float:left;">',n-=1,u=o/n+.99999999,i=0),e+='<label class="checkbox interactionType" title="'+a[s]+'"> <input type="checkbox" class="'+t+'" name="interactions" ',e+='value="'+a[s]+'" checked="checked" /> '+a[s]+" </label>",i+=1,o-=1,a[s];e+='</div></fieldset><br style="clear:both;height:0px;line-height:0px"/>'}),r>0&&(e+='<button onclick="adjustInteractionTypes()">Update Graph!</button>'),$("#informationPane .interactionsContainer").html(e),startGraph()?removeAllMasks():($("#maskLoadStatus").html("An error occurred loading the nodes and edges, it's possible that no data was sent to the graph."),$("#maskLoadStatus").prop("class","alert alert-danger"),setElementToMiddle($("#maskLoadStatus"),$(window)))},error:function(){removeAllMasks(),$("#interactions .interactionsContainer").html("Database Error")},complete:function(){}})}function removeAllMasks(){hideMask(),removeInvisibleMasks()}function toggleSelected(t,e){$(t).hasClass("selected")?$("."+e).attr("checked",!1):$("."+e).attr("checked",!0),$(t).toggleClass("selected")}function maskElement(t,e){var n,r,a,i;e?(r={},n=$(window),r.top=0,r.left=0,a=$(document).height(),i=$(document).width()):(n=$(t),r=n.offset(),a=n.outerHeight(),i=n.outerWidth()),$("#mask").length<1&&($("body").append('<div id="mask"></div>'),$("body").append('<div id="maskLoadStatus" style="position:absolute;display:none;"><img src="/tools/assets/indicator_verybig.gif" width="128" height="128"/></div>')),$("#mask").css({width:i,height:a,top:r.top,left:r.left}),$("#mask, #maskLoadStatus").show(),setElementToMiddle($("#maskLoadStatus"),n),$("#mask, #maskLoadStatus").hide().fadeIn(500)}function hideMask(){$("#maskLoadStatus").fadeOut(500),$("#mask").fadeOut(500)}function setElementToMiddle(t,e){var n=e.outerHeight(),r=e.outerWidth();t.css("top",n/2-t.height()/2),t.css("left",r/2-t.width()/2)}function disableElement(t){for(var e=$(t),n="",r=0;r<e.length;r++)if($(e[r]).is(":visible")){var a=$(e[r]).offset(),i=$(e[r]).outerHeight(),o=$(e[r]).outerWidth();style="width:"+o+"px; height:"+i+"px; top:"+a.top+"px; left:"+a.left+"px;",n=n+'<div id="invisMask'+r+'" class="invisibleMask" style="'+style+'"></div>'}return $("body").append(n),!1}function removeInvisibleMasks(){return $(".invisibleMask").each(function(){$(this).remove()}),!1}function activateInformationPaneMouseOver(){return $("#informationPane .currentFeatureContainer li").unbind(),$("#informationPane .currentFeatureContainer li").on("mouseover",function(){return $(this).addClass("highlight"),highlightSpecificNodes($(this).attr("title"),"feature")}).on("mouseout",function(){return $(this).removeClass("highlight"),removeNodeHighlighting()}),1}function toggleAccordian(t,e){var n=$(t).siblings(".outerContainer"),r=$(t);if(r.hasClass("active"))n.animate({height:0},1e3,function(){r.removeClass("active"),e&&e()});else{n.css("height","auto");var a=n.height();n.height(0).animate({height:a},1e3),r.addClass("active")}}var RadialPlacement=function(){var t,e,n,r,a,i,o,u,s,c;return c=d3.map(),n=20,o=200,t={x:0,y:0},s=180,e=s,i=function(t,e,n){var r=t.x+n*Math.cos(e*Math.PI/180),a=t.y+n*Math.sin(e*Math.PI/180);return{x:r,y:a}},a=function(t){var e=c.get(t);return c.has(t)||(e=r(t)),e},r=function(r){var a=i(t,e,o);return c.set(r,a),e+=n,a},u=function(t){c=d3.map();var e=360/n;t.length<e&&(n=360/t.length);var a=t.slice(0,e);a.forEach(function(t){return r(t)});var i=t.slice(e);return o+=o/1.8,n=360/i.length,i.forEach(function(t){return r(t)})},a.keys=function(t){return arguments.length?(u(t),a):d3.keys(c)},a.center=function(e){return arguments.length?(t=e,a):t},a.radius=function(t){return arguments.length?(o=t,a):o},a.start=function(t){return arguments.length?(s=t,e=s,a):s},a.increment=function(t){return arguments.length?(n=t,a):n},a};Network=function(){var t,e,n,r,a,i,o,u,s,c,l,d,f,h,g,v,p,m,y,k,w,b,x,M,E,S,A,F,C,I,N,T,L,P,D,j,H,O,G,V,R,W,B,_,z,Q,U,q,_,J,K,X;return V=960,l=700,R=2,t=[],n=[],r=[],g={},K={},M=null,v=null,w=null,h=null,f="radial",a="all",B=["all"],W=1,T="nodeCount",J="na",c=null,u=d3.layout.force(),b=d3.scale.category20(),D=Tooltip("vis-tooltip",230),e=function(t){return console.debug(t.radius),-Math.pow(t.radius,2)/2},k=function(e,n){if(t=I(n),!t)return!1;var r=d3.select(e).append("svg").attr("width",V).attr("height",l);v=r.append("g").attr("id","links"),M=r.append("g").attr("id","nodes"),u.size([V,l]),A(f),S(a),j()},j=function(){if(r=o(t.nodes),n=r.length>0?z(t.edges,r):[],"radial"===f){var e=0;r.forEach(function(t){t.hasFeature&&void 0!==t.hasFeature?(t.color=b(t.feature),t.hasFeature=!0):(t.feature="undefined"+e,t.hasFeature=!1,t.color=b(),e++)});var a=L(r,n);H(a)}u.nodes(r),G(),"force"===f?(u.links(n),O()):(u.links([]),h&&(h.data([]).exit().remove(),h=null)),u.start(),"radial"!==f?w.attr("r",function(){return 5}):u.alpha(.1)},k.updateStuff=function(){return j()},k.getNodes=function(){return r},k.printNodes=function(){console.debug(r.length),console.debug(r)},k.printLinks=function(){console.debug(n.length),console.debug(n)},k.toggleLayout=function(t){return u.stop(),A(t),j()},k.toggleFilter=function(t){if(S(t)){if("selectedInteractions"!==a)return u.stop(),j();var e=Q();if(e){var n=r.map(function(t){return t.id});return U(this,n,e)}}},k.toggleSort=function(t){return u.stop(),F(t),j()},k.toggleFeature=function(t){if(void 0===K[t]){var e=r.map(function(t){return t.id});return X(this,e,t),!1}C(t,r);for(var n="<ul>",a={},i=0;i<K[J].length;i++){n+='<li title="'+K[J][i].name+'" style="color:'+b(K[J][i].name)+';" data-pval="'+K[J][i]["p-value"]+'">'+K[J][i].name+"  ("+K[J][i]["p-value"]+")</li>";for(var o=0;o<K[J][i].genes.length;o++)a[K[J][i].genes[o]]={name:K[J][i].name,pval:K[J][i]["p-value"]}}n+="</ul>",w=M.selectAll("circle.node").data(r,function(t){return a[t.id]?(t.feature=a[t.id].name,t.hasFeature=!0,t.pvalue=a[t.id].pval,t.color=b(t.feature)):(t.hasFeature=!1,t.color=b()),t.id}).style("fill",function(t){return b(t.color)});var s=function(){return $("#informationPane .currentFeatureContainer").html(n),$("#currentFeature span").html(t),toggleAccordian(document.getElementById("currentFeature")),activateInformationPaneMouseOver(),u.stop(),j()};return $("#currentFeature").hasClass("active")?toggleAccordian(document.getElementById("currentFeature"),s):s(),1},k.updateFeatureData=function(t,e){K[t]=e;for(var n=0;n<K[t].length;n++)K[t][n]["p-value"]=K[t][n]["p-value"]<.001?K[t][n]["p-value"].toExponential(2):K[t][n]["p-value"]<.05?K[t][n]["p-value"].toFixed(3):K[t][n]["p-value"].toFixed(2);return 1},k.highlightSpecificInteractions=function(t){return q(t)},k.removeLinkHighlighting=function(t){return _(t)},k.updateSearch=function(t){var e=new RegExp(t.toLowerCase());return w.each(function(n){var r=d3.select(this),a=n.name.toLowerCase().search(e);return t.length>0&&a>=0?(r.style("fill","black").style("stroke-width",2).style("stroke","#555"),n.searched=!0):(n.searched=!1,r.style("fill",function(t){return b(t.color)}).style("stroke-width",1))})},k.updateData=function(e){return(t=I(e))?(h&&h.remove(),w&&w.remove(),j()):!1},I=function(t){if(!t||!t.nodes)return!1;t.nodes.forEach(function(t){var e;return t.x=e=Math.floor(Math.random()*V),t.y=e=Math.floor(Math.random()*l),t.radius=R});var e=p(t.nodes);return g={},t.edges.forEach(function(t){return t.source=e.get(t.source),t.target=e.get(t.target),t.iType||(t.iType=[]),g[t.source.id+","+t.target.id]=1}),t},p=function(t){var e=d3.map();return t.forEach(function(t){return e.set(t.id,t)}),e},x=function(t,e){var n={};return t.forEach(function(t){var r,a;return null==(a=n[r=t[e]])&&(n[r]=0),n[t[e]]+=1}),n},y=function(t,e){return g[t.id+","+e.id]||g[e.id+","+t.id]},o=function(t){if(void 0===t)return[];var e=t;return"degreeGreater"===a?e=t.filter(function(t){return t.weight<W}):"degreeLesser"===a&&(e=t.filter(function(t){return t.weight>W})),e},L=function(t,e){var n=[],a={};return"edgeCount"===T?(e.forEach(function(t){var e=t.source.feature;null==a[e]&&(a[e]=0),a[e]+=1,e=t.target.feature,null==a[e]&&(a[e]=0),a[e]+=1}),t.forEach(function(t){t.feature})):"pvalue"===T?($(".currentFeatureContainer li").each(function(){a[$(this).attr("title")]="-"+$(this).attr("data-pval")}),n=d3.entries(a).sort(function(t,e){return e.value-t.value}),n=n.map(function(t){return t.key})):a=x(t,"feature"),n=d3.entries(a).sort(function(t,e){return e.value-t.value}),r.forEach(function(t){void 0===a[t.feature]&&n.push({key:t.feature,value:0})}),n=n.map(function(t){return t.key})},H=function(t){return c=RadialPlacement().center({x:V/2,y:l/2-100}).radius(300).increment(18).keys(t)},z=function(t,e){return i(t,e)},i=function(t,e){return e=p(e),t.filter(function(t){return e.get(t.source.id)&&e.get(t.target.id)})},G=function(){return w=M.selectAll("circle.node").data(r,function(t){return t.id}),w.enter().append("circle").attr("class","node").attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",function(t){return t.radius}).style("stroke",function(t){return P(t)}).style("stroke-width",1).style("fill",function(t){return b(t.color)}),"force"===f?w.call(u.drag):w.on("mousedown.drag",null),w.on("mouseover",N).on("mouseout",d),w.exit().remove()},O=function(){return h=v.selectAll("line.link").data(n,function(t){return t.source.id+"_"+t.target.id}),h.enter().append("line").attr("class","link").attr("stroke","#ddd").attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),h.exit().remove()},A=function(t){return f=t,"force"===f?u.on("tick",s).charge(-200).linkDistance(50):"radial"===f?u.on("tick",E).charge(e):void 0},S=function(t){var e=null;return $("#"+t+"Value").length>0&&(e=$("#"+t+"Value").html()),e!==W||a!==t||"selectedInteractions"==t?(W=e,a=t):!1},C=function(t){return J=t},X=function(t,e,n){var r=$.param({"genes[]":e});return $.ajax({type:"POST",url:"getNodeFeatureData",data:"feature="+n+"&"+r+"&organism=scerevisiae",dataType:"json",beforeSend:function(){disableElement(".control"),maskElement("#graph")},success:function(e){if(e){if(!e.error)return t.updateFeatureData(n,e),t.toggleFeature(n)}else;},complete:function(){hideMask(),removeInvisibleMasks()},error:function(){alert("Database Error")}}),!1},Q=function(){var t=$("#interactions input:checkbox:checked").map(function(){return this.value}).get();return B.compare(t)===!0?!1:t},U=function(t,e,n){var r=$.param({"genes[]":e}),a=$.param({"interactions[]":n});return a&&""!==a||(a="interactions[]"),$.ajax({type:"POST",url:"buildNetwork",data:a+"&"+r+"&organism=scerevisiae",dataType:"json",beforeSend:function(){disableElement(".control"),maskElement("#graph")},success:function(e){if(e){if(!e.error)return t.updateData(e)}else;},complete:function(){hideMask(),removeInvisibleMasks()},error:function(){alert("Database Error")}}),!1},F=function(t){return T=t},s=function(){return w.attr("cx",function(t){return t.x=Math.max(R,Math.min(V-R,t.x))}).attr("cy",function(t){return t.y=Math.max(R,Math.min(l-R,t.y))}),h.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y})},E=function(t){return w.each(m(t.alpha)),w.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}),t.alpha<.03?(u.stop(),O(),h.each(function(t){t.source.weight+=1,t.target.weight+=1}),w.attr("r",function(t){var e=Math.max(R,R+2*Math.log(t.weight));return t.radius=e,e}),1):void 0},m=function(t){var e=.1*t;return function(t){var n=c(t.feature);return t.x+=(n.x-t.x)*e,t.y+=(n.y-t.y)*e}},P=function(t){return d3.rgb(b(t.color)).darker().toString()},N=function(t){var e='<p class="main">'+t.id+"</span></p>",n="na";return n=t.feature,e+='<hr class="tooltip-hr">',e+='<p class="main">'+n+"</span></p>",D.showTooltip(e,d3.event),h&&h.style("stroke",function(e){return e.source===t||e.target===t?"#555":"#ddd"}).style("stroke-width",function(e){return e.source===t||e.target===t?2:1}).style("stroke-opacity",function(e){return e.source===t||e.target===t?1:.5}),w.style("stroke",function(e){return e.searched||y(t,e)?"#555":P(e)}).style("stroke-width",function(e){return e.searched||y(t,e)?2:1}),d3.select(this).style("stroke","black").style("stroke-width",5)},d=function(){return D.hideTooltip(),w.style("stroke",function(t){return t.searched?"#555":P(t)}).style("stroke-width",function(t){return t.searched?2:1}).style("stroke-opacity",function(){return 1}),h?h.style("stroke","#ddd").style("stroke-width",1):void 0},q=function(t){h&&h.style("stroke",function(e){return e.iType===t?"#555":void 0}).style("stroke-opacity",function(e){return e.iType===t?1:.5})},_=function(){h&&h.style("stroke",function(){return"#ddd"}).style("stroke-opacity",function(){return 1})},highlightSpecificNodes=function(t,e){return w?w.each(function(n){if(n[e]===t){var r=d3.select(this);return r.style("fill","black").style("stroke-width",2)}}):void 0},removeNodeHighlighting=function(){return w?w.each(function(t){var e=d3.select(this);return e.style("fill",b(t.color)).style("stroke-width",1)}):void 0},k},activate=function(t,e){if(d3.selectAll("#"+t+" .controlItem").classed("active",!1),d3.selectAll("#"+t+" .dropdown-menu li").classed("active",!1),d3.selectAll("#"+t+" .valueDisplay").text("-"),$(e).parent("li").hasClass("controlItem"))return $(e).parent("li").addClass("active"),$(e).parent().attr("id");var n=$(e).closest("ul");if(n.hasClass("dropdown-menu")&&n.parent().hasClass("controlItem")){n.parent("li").addClass("active");var r,a;if(void 0!==e.attr("id")?(r=e.attr("id"),a=n.parent().attr("id"),r=$(e).html()):(r=n.parent(),a=r.attr("id")),$("#"+a+"Value").length>0)return $("#"+a+"Value").html($(e).html()),$(e).parent("li").addClass("active"),r}return!1};var myNetwork;getInteractionTypes(),Array.prototype.compare=function(t){if(!t)return!1;if(this.length!=t.length)return!1;for(var e=0;e<this.length;e++)if(this[e]instanceof Array&&t[e]instanceof Array){if(!this[e].compare(t[e]))return!1}else if(this[e]!=t[e])return!1;return!0},$(function(){$("#informationPane .heading").click(function(){toggleAccordian(this)})});